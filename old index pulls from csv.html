<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lonny Grafman — Projects</title>
  <meta name="description" content="Lonny Grafman’s portfolio of engineering design, resilient community projects, entrepreneurship, and education." />
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Crimson+Pro:wght@400;600&display=swap" rel="stylesheet">

  <style>
    /* --- CSS Variables --- */
    :root{
      --paper:#F7F7F5; /* background */
      --charcoal:#111827; /* headings/text */
      --ink:#374151; /* body text */
      --accent:#0EA5A4; /* links, hovers */
      --punk:#A3E635; /* focus ring */
      --card:#FFFFFF;
      --border:rgba(17,24,39,0.08);
      --shadow:0 2px 8px rgba(0,0,0,.06), 0 1px 0 rgba(0,0,0,.02);
      --shadow-hover:0 12px 34px rgba(0,0,0,.18), 0 6px 18px rgba(0,0,0,.08);
      --radius:18px;
      --gap:clamp(12px, 2.2vw, 20px);
      --transition:150ms cubic-bezier(.2,.6,.2,1);
    }

    /* --- Base / Typography --- */
    html,body{height:100%;}
    body{margin:0;background:var(--paper);color:var(--ink);font:16px/1.5 Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;}
    h1,h2,h3{color:var(--charcoal);line-height:1.2;margin:0 0 .6rem;}
    h1{font-size:clamp(1.6rem,2.4vw,2.3rem);font-weight:800}
    h2{font-size:clamp(1.2rem,1.7vw,1.5rem);font-weight:700}
    h3{font-size:clamp(1rem,1.2vw,1.05rem);font-weight:700}
    p{margin:.5rem 0 0}
    a{color:var(--accent);text-decoration:none}
    a:hover{text-decoration:underline}

    /* --- Layout --- */
    header{position:sticky;top:0;z-index:20;background:color-mix(in oklab, var(--paper) 92%, white 8%);backdrop-filter:saturate(1.1) blur(6px);border-bottom:1px solid var(--border);
      transition:background var(--transition), border-color var(--transition), box-shadow var(--transition)}
    .wrap{max-width:1200px;margin:0 auto;padding:14px 18px}
    nav{display:flex;gap:18px;align-items:center}
    nav a{font-weight:600;color:var(--charcoal);padding:8px 10px;border-radius:10px}
    nav a:focus-visible{outline:2px solid var(--punk);outline-offset:2px}

    main{padding:24px 18px 80px}
    .section{max-width:1200px;margin:0 auto}

    /* compact header on scroll */
    body.is-scrolled header{background:color-mix(in oklab, var(--paper) 88%, white 12%);border-bottom-color:rgba(17,24,39,0.12);box-shadow:0 6px 18px rgba(0,0,0,.08)}
    body.is-scrolled header .wrap{padding:8px 18px}
    @media (prefers-reduced-motion:reduce){header,.wrap{transition:none !important}}

    /* --- Grid (Option A) --- */
    .grid{display:grid;gap:var(--gap)}
    @media (min-width:1440px){.grid{grid-template-columns:repeat(5,1fr)}}
    @media (min-width:1024px) and (max-width:1439px){.grid{grid-template-columns:repeat(4,1fr)}}
    @media (min-width:768px) and (max-width:1023px){.grid{grid-template-columns:repeat(3,1fr)}}
    @media (min-width:520px) and (max-width:767px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:519px){.grid{grid-template-columns:1fr}}

    /* --- Card / Tile --- */
    .card{display:block;background:var(--card);border:1px solid rgba(17,24,39,0.12);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;transition:transform var(--transition), box-shadow var(--transition), border-color var(--transition);will-change:transform}
    .card:hover{transform:translateY(-3px) scale(1.01);box-shadow:var(--shadow-hover)}
    .card:focus-within{transform:translateY(-2px) scale(1.005);box-shadow:var(--shadow-hover)}
    .card:active{transform:translateY(-1px) scale(1.003)}
    .thumb{position:relative;aspect-ratio:16/9;background:#e5e7eb;overflow:hidden}
    .thumb img{width:100%;height:100%;object-fit:cover;display:block;filter:saturate(1.02);transition:transform var(--transition);transform:scale(1)}
    .card:hover .thumb img{transform:scale(1.02)}
    .img-skeleton{position:absolute;inset:0;background:linear-gradient(100deg,#f2f3f2 10%,#e6e7e6 30%,#f2f3f2 50%);background-size:200% 100%;animation:shimmer 1.2s infinite;}
    @keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}

    /* Overlay (on-hover, on-focus, always-on for touch) */
    .overlay{
      position:absolute; inset:auto 0 0 0;
      display:flex; align-items:flex-end;
      padding:10px 12px; color:#fff;
      background: linear-gradient(
        to top,
        rgba(0,0,0,.72),
        rgba(0,0,0,.45) 40%,
        rgba(0,0,0,0) 68%
      );
      opacity:0; transition:opacity var(--transition)
    }
    .overlay h3{margin:0;font-weight:700;letter-spacing:.2px;text-shadow:0 1px 2px rgba(0,0,0,.5)}
    .card:focus-within .overlay,.card:hover .overlay{opacity:1}
    @media (hover:none){.overlay{opacity:1}}
    @media (prefers-contrast: more){
      .overlay{
        background: linear-gradient(
          to top,
          rgba(0,0,0,.85),
          rgba(0,0,0,.55) 40%,
          rgba(0,0,0,0) 70%
        );
      }
    }

    .meta{padding:12px 12px 16px}
    .reason{color:var(--ink);font-size:.95rem;line-height:1.45}

    /* --- Modal / Lightbox (shared styles) --- */
    dialog{border:none;border-radius:18px;padding:0;max-width:min(860px,94vw);width:100%;box-shadow:0 30px 80px rgba(0,0,0,.35)}
    dialog::backdrop{background:rgba(17,24,39,.55);backdrop-filter:saturate(.9) blur(2px)}
    .modal{display:grid;grid-template-columns:1fr;gap:0}
    .modal header{position:sticky;top:0;background:var(--card);border-bottom:1px solid var(--border);border-radius:18px 18px 0 0}
    .modal .head{display:flex;justify-content:space-between;align-items:center;padding:14px 18px}
    .modal .title{margin:0;font-size:1.4rem}
    .close-btn{
      appearance:none;border:none;background:transparent;font-size:1.5rem;line-height:1;
      padding:10px 12px;min-width:44px;min-height:44px;border-radius:10px;cursor:pointer;color:var(--charcoal)
    }
    .close-btn:focus-visible{outline:2px solid var(--punk);outline-offset:3px}
    .modal .body{padding:20px 22px 22px}
    .muted{color:#6B7280;font-size:.95rem}
    .meta-row{margin-top:12px;color:#4B5563;font-size:.95rem;line-height:1.4}
    .links{margin-top:14px;display:flex;flex-wrap:wrap;gap:12px}
    .links a{display:inline-flex;align-items:center;gap:6px;padding:8px 12px;border:1px solid var(--border);border-radius:10px;background:#fff;transition:background var(--transition);font-weight:600}
    .links a:hover{background:#fafafa}

    /* Modal field groups (titles before text) */
    .field{margin-top:14px}
    .field h4{margin:0 0 6px;font-size:1rem;color:var(--charcoal)}
    .field p{margin:0;color:var(--ink);line-height:1.5}

    /* --- About section --- */
    #about{margin-top:56px;padding-top:16px}
    .about-grid{
      display:grid; gap:18px; align-items:start;
      grid-template-columns: 120px 1fr;
    }
    @media (min-width:768px){
      .about-grid{ grid-template-columns: 220px 1fr; gap:24px; }
    }
    .about-photo{
      width:100%; aspect-ratio:1/1; object-fit:cover;
      border-radius:18px; border:1px solid var(--border); box-shadow:var(--shadow);
      background:#e5e7eb; display:block;
    }
    .about-btn{
      all:unset; display:block; cursor:pointer; border-radius:18px;
    }
    .about-btn:focus-visible{outline:2px solid var(--punk); outline-offset:4px; border-radius:18px}
    .lead{font-family:"Crimson Pro", serif;font-size:1.1rem;color:var(--charcoal)}

    /* Footer */
    footer{border-top:1px solid var(--border);margin-top:48px}
    footer .wrap{display:flex;flex-wrap:wrap;align-items:center;justify-content:space-between;padding:18px}
    .footer-links{display:flex;gap:14px;flex-wrap:wrap}
    .footer-links a{color:var(--ink);font-weight:600}
    .footer-links a:focus-visible{outline:2px solid var(--punk);outline-offset:2px}
    .footer-copy{color:#6B7280;font-size:.9rem}

    /* Focus styles */
    :focus-visible{outline:2px solid var(--punk);outline-offset:2px}
    .tile-btn:focus-visible{outline:2px solid var(--punk);outline-offset:4px;border-radius:var(--radius)}

    /* Reduced motion */
    @media (prefers-reduced-motion:reduce){
      *{animation:none!important;transition:none!important}
      .card,.card:hover,.card:focus-within,.card:active{transform:none!important}
      .thumb img{transform:none!important}
    }

    /* Utility */
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  </style>

  <!-- Load runtime config (CSV_URL lives here by default) -->
  <script src="config.js"></script>
</head>
<body>
  <header>
    <div class="wrap">
      <nav aria-label="Primary">
        <a href="#projects">Projects</a>
        <a href="#about">About</a>
        <a href="#contact">Contact</a>
      </nav>
    </div>
  </header>

  <main>
    <section id="projects" class="section" aria-labelledby="projects-title">
      <h1 id="projects-title">Projects</h1>
      <div id="grid" class="grid" role="list" aria-label="Project tiles"></div>
    </section>

    <section id="about" class="section" aria-labelledby="about-title">
      <h2 id="about-title">About</h2>

      <div class="about-grid">
        <button class="about-btn" id="about-open" aria-label="Open About details">
          <img class="about-photo" loading="lazy" decoding="async"
               src="https://www.dropbox.com/scl/fi/jshcb7c7l9z9os8x2j276/facm101724_00103-1.jpg?rlkey=bxl26w40o707fv3vjg9nsdhqh&raw=1"
               alt="Photo of Lonny Grafman" referrerpolicy="no-referrer">
        </button>
        <div>
          <p class="lead">
            Author, Designer, Educator, Facilitator, Presenter, and most importantly teammate with people making epic stuff happen.
          </p>
          <p style="margin-top:.5rem;color:#6B7280">Tap the photo to read more.</p>
        </div>
      </div>
    </section>

    <section id="contact" class="section" aria-labelledby="contact-title">
      <h2 id="contact-title">Contact</h2>
      <p>Email: <a href="mailto:you@example.com">you@example.com</a></p>
      <p><!-- Insert your Mailchimp embed here (with honeypot/reCAPTCHA as needed) --></p>
    </section>
  </main>

  <!-- Project Modal -->
  <dialog id="project-modal" aria-label="Project details">
    <div class="modal" role="document">
      <header>
        <div class="head">
          <h3 class="title" id="modal-title">Title</h3>
          <button class="close-btn" type="button" aria-label="Close" data-close>&times;</button>
        </div>
      </header>
      <div class="body">
        <!-- Titles before text -->
        <div class="field" id="field-reason">
          <h4>Reason</h4>
          <p class="muted" id="modal-reason"></p>
        </div>

        <div class="field" id="field-description">
          <h4>Description</h4>
          <p id="modal-description"></p>
        </div>

        <div class="field" id="field-impacts">
          <h4>Impacts</h4>
          <p id="modal-impacts"></p>
        </div>

        <div class="field" id="field-roles">
          <h4>Roles</h4>
          <p id="modal-roles"></p>
        </div>

        <p class="meta-row" id="field-dates"><span id="modal-dates"></span></p>

        <div class="links" id="modal-links"></div>
      </div>
    </div>
  </dialog>

  <!-- About Modal -->
  <dialog id="about-modal" aria-label="About Lonny">
    <div class="modal" role="document">
      <header>
        <div class="head">
          <h3 class="title">About Lonny</h3>
          <button class="close-btn" type="button" aria-label="Close" data-close-about>&times;</button>
        </div>
      </header>
      <div class="body">
        <p>I love working with awesome people to make great things happen.</p>

        <p>My international experience includes teaching at Universities in Mexico, Spain and Dominican Republic, and India, as well as founding a summer abroad, full immersion programs in resilient community technologies.</p>

        <p>As a teacher, I have a passion to foster creativity, deepen analytic abilities, increase competence, strengthen connections, and generally broaden knowledge in students primarily by working on real projects, with real clients, that ameliorate existing conditions by leveraging local knowledge, wealth and labor through transparency and stakeholder participation. Ultimately, I want the synthesis of the experience to engender a strong, and accurate, sense of competence and integrity in students, so that they can go on to accomplish their own goals.</p>

        <p>In my classroom, I try to foster a sense of openness through humor, fallibility, and modeling positive actions to critical feedback. Together, the students and I continue to improve the curriculum by collaboratively developing and evolving our course. As part of honoring the value that each of us bring, and celebrating that diverse teams are necessary to tackle the problems facing the world, we engage many styles that allow students of various needs, skills, and ways of being to thrive.</p>

        <p>I focus on building resilience in communities, organizations, and individuals by leveraging our own resources to meet our own needs. I do this in the teaching ways noted above and through my roles as the president of Appropedia (sharing these solutions), director of the AWEsome Business Competition (hacking capitalism and giving more opportunities to these projects), author of books like To Catch the Rain and To Catch the Sun (so anyone can start catching their own resources), and advising with people, projects, and organizations. You might like to check out our solarpunk projects like Waterpod and Swale (a floating food barge in New York).</p>

        <p>I love getting to present on any and all of these things!</p>

        <p><strong>Projects:</strong> rainwater; greywater; earthen ovens; adobe buildings; parabolic cookers; composters; photovoltaic systems; upcycling; wastewater treatment; information technology; waste reduction/energy conservation packages; solar hot water; social entrepreneurship; and many more.</p>
      </div>
    </div>
  </dialog>

  <!-- Tile template -->
  <template id="tile-template">
    <article class="card" role="listitem">
      <button class="tile-btn" style="all:unset;display:block;cursor:pointer" aria-label="Open project">
        <div class="thumb">
          <div class="img-skeleton" aria-hidden="true"></div>
          <img alt="" loading="lazy" decoding="async">
          <div class="overlay"><h3></h3></div>
        </div>
        <div class="meta"><p class="reason"></p></div>
      </button>
    </article>
  </template>

  <script>
  // ==== CONFIG ====
  const CSV_URL = new URLSearchParams(location.search).get('csv')
    || (window.PORTFOLIO_CONFIG && window.PORTFOLIO_CONFIG.CSV_URL)
    || "";

  // ==== CSV PARSER ====
  function parseCSV(text){
    const rows = [];
    let i = 0, field = '', row = [], inQuotes = false;
    while(i < text.length){
      const c = text[i];
      if(inQuotes){
        if(c === '"'){
          if(text[i+1] === '"'){ field += '"'; i++; }
          else { inQuotes = false; }
        } else { field += c; }
      } else {
        if(c === '"'){ inQuotes = true; }
        else if(c === ','){ row.push(field); field = ''; }
        else if(c === '\n'){
          row.push(field); rows.push(row); row = []; field = '';
        } else if(c !== '\r'){ field += c; }
      }
      i++;
    }
    if(field.length || row.length){ row.push(field); rows.push(row); }
    const headers = rows.shift().map(h => h.trim());
    return rows.filter(r => r.length && r.some(x => x && x.trim() !== ''))
      .map(r => Object.fromEntries(headers.map((h, idx) => [h, (r[idx] ?? '').trim()])));
  }

  // ==== Helpers ====
  const normalizeBool = v => (String(v).toLowerCase().trim() === 'true' || v === '1' || String(v).toLowerCase() === 'yes');
  const toNumber = v => { const n = Number(v); return Number.isFinite(n) ? n : 9999; };
  function deriveAlt({ title, reason }){
    const s = `${title || ''}${reason ? ' — ' + reason : ''}`.trim();
    return s.length > 160 ? s.slice(0,157) + '…' : s || 'Project image';
  }
  function parseLinks(cell){
    if(!cell) return [];
    return cell.split(';').map(s => s.trim()).filter(Boolean).map(pair => {
      const [label, url] = pair.includes('|') ? pair.split('|') : [pair, pair];
      return { label: (label||'Link').trim(), url: (url||'').trim() };
    }).filter(x => x.url);
  }

  // Convert share URLs → direct images
  function coerceImageURL(u){
    if(!u) return '';
    try{
      if(/^\/?\/?[^\s]+\.[^\s]+/.test(u) && !/^https?:/i.test(u)){
        u = (u.startsWith('//') ? 'https:' : 'https://') + u.replace(/^\/+/, '');
      }
      const url = new URL(u);
      const host = url.hostname;
      const path = url.pathname;

      if(host === 'drive.google.com'){
        const m = path.match(/\/file\/d\/([^/]+)/);
        const id = m ? m[1] : (url.searchParams.get('id') || '');
        if(id) return `https://drive.google.com/uc?export=view&id=${id}`;
      }
      if(host.endsWith('dropbox.com')){
        url.searchParams.delete('dl'); url.searchParams.set('raw','1');
        return url.toString();
      }
      if(host.endsWith('github.com') && path.includes('/blob/')){
        return url.toString().replace('/blob/','/raw/');
      }
      if(host.endsWith('appropedia.org')){
        const mFile = path.match(/^\/(wiki\/)?File:(.+)$/);
        if(mFile){
          const fname = mFile[2];
          return `https://www.appropedia.org/Special:FilePath/${encodeURIComponent(fname)}`;
        }
      }
      if(host === 'photos.google.com' || host === 'photos.app.goo.gl'){
        console.warn('Google Photos links do not hotlink. Use an lh3.googleusercontent.com URL.', u);
      }
      return u;
    }catch(e){ return u; }
  }
  function extractDriveId(u){
    if(!u) return '';
    try{
      const url = new URL(u);
      if(url.hostname === 'drive.google.com'){
        const m = url.pathname.match(/\/file\/d\/([^/]+)/);
        return m ? m[1] : (url.searchParams.get('id') || '');
      }
      return '';
    }catch(e){ return ''; }
  }
  function pickField(r, names){
    for(const k of names){ if(r[k] && String(r[k]).trim() !== '') return String(r[k]).trim(); }
    return '';
  }

  // ==== State ====
  let PROJECTS = [];
  let PREV_HASH = location.hash;

  // ==== Rendering ====
  const grid = document.getElementById('grid');
  const tpl = document.getElementById('tile-template');

  function renderGrid(items){
    grid.innerHTML = '';
    for(const item of items){
      const node = tpl.content.firstElementChild.cloneNode(true);
      const btn = node.querySelector('.tile-btn');
      const img = node.querySelector('img');
      const skel = node.querySelector('.img-skeleton');
      const titleEl = node.querySelector('.overlay h3');
      const reasonEl = node.querySelector('.reason');

      node.dataset.slug = item.slug;
      titleEl.textContent = item.title || 'Untitled';
      reasonEl.textContent = item.reason || '';

      img.alt = deriveAlt(item);
      img.referrerPolicy = 'no-referrer';
      const resolvedSrc = coerceImageURL(item.image || '');
      img.src = resolvedSrc;

      img.addEventListener('load', () => skel.remove());
      img.addEventListener('error', () => {
        const driveId = extractDriveId(item.image || resolvedSrc);
        if(driveId && !img.dataset.driveTried){
          img.dataset.driveTried = '1';
          img.src = `https://drive.google.com/thumbnail?id=${driveId}&sz=w1600`;
          return;
        }
        console.warn('Image failed to load. Original:', item.image, 'Resolved:', resolvedSrc);
        skel.remove();
        const thumb = img.closest('.thumb');
        img.remove();
        const fallback = document.createElement('div');
        fallback.setAttribute('aria-hidden','true');
        fallback.style.cssText = 'position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:#e5e7eb;color:#6b7280;font-weight:600;font-size:0.95rem;';
        fallback.textContent = 'Image unavailable';
        thumb.appendChild(fallback);
      });

      btn.setAttribute('aria-label', `Open project: ${item.title}`);
      btn.addEventListener('click', (e) => { e.preventDefault(); openModalBySlug(item.slug); });

      grid.appendChild(node);
    }
  }

  // ==== Modals ====
  const projectDialog = document.getElementById('project-modal');
  const aboutDialog = document.getElementById('about-modal');

  // Project modal outputs
  const titleOut = document.getElementById('modal-title');
  const fieldReason = document.getElementById('field-reason');
  const fieldDesc   = document.getElementById('field-description');
  const fieldImp    = document.getElementById('field-impacts');
  const fieldRoles  = document.getElementById('field-roles');
  const fieldDates  = document.getElementById('field-dates');
  const reasonOut = document.getElementById('modal-reason');
  const descOut   = document.getElementById('modal-description');
  const impOut    = document.getElementById('modal-impacts');
  const rolesOut  = document.getElementById('modal-roles');
  const datesOut  = document.getElementById('modal-dates');
  const linksOut  = document.getElementById('modal-links');

  const closeBtnProject = projectDialog.querySelector('[data-close]');
  closeBtnProject.addEventListener('click', closeProjectModal);
  projectDialog.addEventListener('cancel', (e) => { e.preventDefault(); closeProjectModal(); });
  projectDialog.addEventListener('click', (e) => { if(e.target === projectDialog) closeProjectModal(); });

  const closeBtnAbout = aboutDialog.querySelector('[data-close-about]');
  closeBtnAbout.addEventListener('click', closeAboutModal);
  aboutDialog.addEventListener('cancel', (e) => { e.preventDefault(); closeAboutModal(); });
  aboutDialog.addEventListener('click', (e) => { if(e.target === aboutDialog) closeAboutModal(); });

  function setField(container, el, value){
    if(value && String(value).trim() !== ''){
      container.style.display = '';
      el.textContent = value;
    }else{
      container.style.display = 'none';
      el.textContent = '';
    }
  }

  function fillModal(item){
    titleOut.textContent = item.title || 'Untitled';
    setField(fieldReason, reasonOut, item.reason);
    setField(fieldDesc,   descOut,   item.description);
    setField(fieldImp,    impOut,    item.impacts);
    setField(fieldRoles,  rolesOut,  item.roles);
    if(item.dates && item.dates.trim() !== ''){
      fieldDates.style.display = '';
      datesOut.textContent = `Dates: ${item.dates}`;
    }else{
      fieldDates.style.display = 'none';
      datesOut.textContent = '';
    }
    linksOut.innerHTML = '';
    for(const link of parseLinks(item.links)){
      const a = document.createElement('a');
      a.target = '_blank'; a.rel = 'noopener';
      a.href = link.url; a.textContent = link.label;
      linksOut.appendChild(a);
    }
  }

  function openModalBySlug(slug){
    const item = PROJECTS.find(p => p.slug === slug);
    if(!item) return;
    fillModal(item);
    if(location.hash !== `#/project/${slug}`){
      PREV_HASH = location.hash;
      location.hash = `#/project/${slug}`;
    }
    if(!projectDialog.open){ projectDialog.showModal(); }
    trapFocus(projectDialog);
  }
  function closeProjectModal(){
    if(projectDialog.open) projectDialog.close();
    if(PREV_HASH && PREV_HASH.startsWith('#/project/')){
      history.pushState('', document.title, window.location.pathname + window.location.search);
    }
  }

  // About modal open/close
  const aboutOpenBtn = document.getElementById('about-open');
  if(aboutOpenBtn){
    aboutOpenBtn.addEventListener('click', (e) => {
      e.preventDefault();
      PREV_HASH = location.hash;
      location.hash = '#/about';
      if(!aboutDialog.open) aboutDialog.showModal();
      trapFocus(aboutDialog);
    });
  }
  function closeAboutModal(){
    if(aboutDialog.open) aboutDialog.close();
    if(location.hash === '#/about'){
      history.pushState('', document.title, window.location.pathname + window.location.search);
    }
  }

  // Hash routing for deep links
  function getHashSlug(){
    const m = location.hash.match(/^#\/project\/([^\s?#]+)/);
    return m ? decodeURIComponent(m[1]) : null;
  }
  window.addEventListener('hashchange', () => {
    if(location.hash === '#/about'){
      if(!aboutDialog.open) aboutDialog.showModal();
      trapFocus(aboutDialog);
      return;
    }
    const slug = getHashSlug();
    if(slug){ openModalBySlug(slug); }
    else {
      if(projectDialog.open) projectDialog.close();
      if(aboutDialog.open) aboutDialog.close();
    }
  });

  // Focus trap
  function trapFocus(root){
    const FOCUSABLE = 'a[href],button:not([disabled]),textarea,input,select,details,[tabindex]:not([tabindex="-1"])';
    const focusables = [...root.querySelectorAll(FOCUSABLE)].filter(el => el.offsetParent !== null);
    const first = focusables[0];
    const last = focusables[focusables.length - 1];
    if(first) first.focus();
    function onKey(e){
      if(e.key !== 'Tab') return;
      if(e.shiftKey && document.activeElement === first){ e.preventDefault(); last.focus(); }
      else if(!e.shiftKey && document.activeElement === last){ e.preventDefault(); first.focus(); }
    }
    root.addEventListener('keydown', onKey, { once: true });
  }

  // ==== Boot ====
  async function boot(){
    try{
      if(location.protocol === 'file:'){
        console.warn('Tip: serve over http(s) (e.g., python3 -m http.server) so cross-origin fetch works.');
      }
      if(!CSV_URL){ console.warn('CSV_URL is empty. Set it in config.js or pass ?csv=...'); }

      let text;
      try {
        const res = await fetch(CSV_URL);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        text = await res.text();
      } catch (e) {
        console.warn('Direct CSV fetch failed, trying CORS proxy…', e);
        const proxied = `https://api.allorigins.win/raw?url=${encodeURIComponent(CSV_URL)}`;
        const res2 = await fetch(proxied);
        if (!res2.ok) throw new Error(`HTTP ${res2.status} via proxy`);
        text = await res2.text();
      }

      const rows = parseCSV(text);
      hydrate(rows);
    } catch(err){
      console.error(err);
      const grid = document.getElementById('grid');
      const msg = `Could not load projects. ${err && err.message ? '('+err.message+')' : ''}`;
      grid.innerHTML = `<div style="padding:12px;border:1px solid var(--border);border-radius:12px;background:#fff">
        <p>${msg}</p>
        <p><small>CSV_URL:</small> <code>${CSV_URL}</code></p>
        <p><small>Tips:</small> Publish the Sheet to the web as CSV; test the link in a new tab; and serve this file over http(s). A temporary proxy (api.allorigins.win) is used if CORS blocks direct fetch.</p>
      </div>`;
    }
  }

  function hydrate(rows){
    const pick = (r, names) => pickField(r, names);
    PROJECTS = rows.map(r => {
      const image = pick(r,['image','Image','image_url','image url','img','thumbnail','thumb','Image (image file)','image (image file)']);
      const title = pick(r,['title','Title','overlay','overlay text','name']);
      const reason = pick(r,['reason','Reason','subtitle','subheading','The Reason']);
      const description = pick(r,['description','Description','desc']);
      const impacts = pick(r,['impacts','Impacts','impact']);
      const dates = pick(r,['dates','Dates','date','year']);
      const roles = pick(r,['roles','Roles','role']);
      const links = pick(r,['links','Links']);
      const tags = pick(r,['tags','Tags']);
      const slug = pick(r,['slug','Slug','id','ID']);
      const publishedRaw = pick(r,['published','Published','publish','Publish']);
      const orderRaw = pick(r,['order_weight','order','Order','weight','Weight']);
      return {
        slug,image,title,reason,description,impacts,dates,roles,links,tags,
        order_weight: toNumber(orderRaw),
        published: normalizeBool(publishedRaw)
      };
    })
    .filter(p => p.published)
    .sort((a,b) => (a.order_weight - b.order_weight) || String(a.title).localeCompare(String(b.title)));

    renderGrid(PROJECTS);

    if(PROJECTS.length === 0){
      grid.innerHTML = '<p>No published projects found. Check your Sheet headers and set <code>published</code> to TRUE.</p>';
    }

    const slug = getHashSlug();
    if(slug) openModalBySlug(slug);
    if(location.hash === '#/about'){ if(!aboutDialog.open) aboutDialog.showModal(); trapFocus(aboutDialog); }
  }

  boot();

  // Footer year
  document.addEventListener('DOMContentLoaded', () => {
    const y = document.getElementById('year');
    if (y) y.textContent = new Date().getFullYear();
  });

  // Compact header on scroll
  (() => {
    const toggle = () => document.body.classList.toggle('is-scrolled', window.scrollY > 6);
    toggle();
    window.addEventListener('scroll', toggle, { passive: true });
  })();
  </script>

  <!-- Footer -->
  <footer>
    <div class="wrap">
      <div class="footer-links" aria-label="Social links">
        <a href="https://instagram.com/lonnygrafman" target="_blank" rel="noopener">Instagram</a>
        <a href="https://www.linkedin.com/in/lonnygrafman/" target="_blank" rel="noopener">LinkedIn</a>
        <a href="https://www.facebook.com/LonnyG" target="_blank" rel="noopener">Facebook</a>
        <a href="https://www.youtube.com/user/LonnyGrafman" target="_blank" rel="noopener">YouTube</a>
      </div>
      <div class="footer-copy">© <span id="year"></span> Lonny Grafman</div>
    </div>
  </footer>

  <!-- GA4 (optional): paste your GA snippet here when deploying) -->
</body>
</html>
